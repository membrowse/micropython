name: Onboard to Membrowse

on:
  workflow_dispatch:
    inputs:
      num_commits:
        description: 'Number of commits to process'
        required: true
        default: '100'
        type: string

jobs:
  onboard:
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        include:
          # STM32 target
          - target_name: stm32-pybv11
            port: stm32
            board: PYBV11
            build_cmd: ci_stm32_pyb_build
            elf: ports/stm32/build-PYBV11/firmware.elf
            ld: "ports/stm32/boards/stm32f405.ld ports/stm32/boards/common_ifs.ld"

          # RP2 target (Raspberry Pi Pico - RP2040)
          - target_name: rp2-pico
            port: rp2
            board: RPI_PICO
            build_cmd: ci_rp2_build
            elf: ports/rp2/build-RPI_PICO/firmware.elf
            ld: "ports/rp2/memmap_mp_rp2040.ld"
            linker_vars: "__micropy_flash_size__=2048k __micropy_c_heap_size__=0"

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # STM32-specific setup
      - name: Install STM32 packages
        if: matrix.port == 'stm32'
        run: source tools/ci.sh && ci_stm32_setup

      - name: STM32 ccache
        if: matrix.port == 'stm32'
        uses: hendrikmuhs/ccache-action@v1.2
        with:
          key: stm32-${{ matrix.board }}

      # RP2-specific setup
      - name: Install RP2 packages
        if: matrix.port == 'rp2'
        run: source tools/ci.sh && ci_rp2_setup

      - name: RP2 ccache
        if: matrix.port == 'rp2'
        uses: hendrikmuhs/ccache-action@v1.2
        with:
          key: rp2-${{ matrix.board }}

      # Run Membrowse Onboard Action
      - name: Run Membrowse Onboard Action
        uses: membrowse/membrowse-action/onboard-action@main
        with:
          target_name: ${{ matrix.target_name }}
          num_commits: ${{ github.event.inputs.num_commits }}
          build_script: source tools/ci.sh && ${{ matrix.build_cmd }}
          elf: ${{ matrix.elf }}
          ld: ${{ matrix.ld }}
          linker_vars: ${{ matrix.linker_vars }}
          api_key: ${{ secrets.MEMBROWSE_API_KEY }}
          api_url: ${{ vars.MEMBROWSE_API_URL }}